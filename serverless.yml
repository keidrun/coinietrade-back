service: &service
  name: coinietrade-back
  frameworkVersion: "=1.26.1"

plugins:
  - serverless-dynamodb-local
  - serverless-offline-scheduler
  - serverless-offline

provider:
  name: aws
  runtime: nodejs8.10
  stage: ${opt:stage, 'dev'}
  profile: ${file(./config/config.yml):${self:provider.stage}.profile, 'default'}
  region: ${file(./config/config.yml):${self:provider.stage}.region, 'us-east-1'}
  memorySize: 1024
  timeout: 6
  logRetentionInDays: 14
  apiKeys:
    - ${opt:stage, self:provider.stage}-privateApiKey
  environment:
    NODE_ENV: ${file(./config/config.yml):${self:provider.stage}.node_env, 'development'}
    SERVICE_NAME: ${self:custom.service.name}
    STAGE: ${self:provider.stage}
    DYNAMODB_ACCESS_KEY_ID: ${file(./config/config.yml):${self:provider.stage}.aws_access_key_id}
    DYNAMODB_SECRET_ACCESS_KEY: ${file(./config/config.yml):${self:provider.stage}.aws_secret_access_key}
    DYNAMODB_REGION: ${self:provider.region}
    # Table names on DynamoDB
    DYNAMODB_TABLE_POLICIES: ${self:custom.service.name}_policies_${self:provider.stage}
    DYNAMODB_TABLE_SECRETS: ${self:custom.service.name}_secrets_${self:provider.stage}
    DYNAMODB_TABLE_RULES: ${self:custom.service.name}_rules_${self:provider.stage}
    DYNAMODB_TABLE_TRANSACTIONS: ${self:custom.service.name}_transactions_${self:provider.stage}
    # Secret encrypt
    ENCRYPT_KEY: ${file(./config/config.yml):${self:provider.stage}.encrypt_key}
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${self:provider.region}:*:table/*"

package:
  include:
    - src/api/**
    - src/models/**
    - src/services/**
    - src/messages/**
    - src/utils/**
    - src/scheduler/**

functions:
  # Policies API
  getPolicies:
    handler: src/api/handler.getPolicies
    events:
      - http:
          method: get
          path: v1/policies
          private: true
          cors: false
  getPolicy:
    handler: src/api/handler.getPolicy
    events:
      - http:
          method: get
          path: v1/policies/{userId}
          private: true
          cors: false
  addPolicy:
    handler: src/api/handler.addPolicy
    events:
      - http:
          method: post
          path: v1/policies
          private: true
          cors: false
  removePolicy:
    handler: src/api/handler.removePolicy
    events:
      - http:
          method: delete
          path: v1/policies/{userId}
          private: true
          cors: false
  updatePolicy:
    handler: src/api/handler.updatePolicy
    events:
      - http:
          method: patch
          path: v1/policies/{userId}
          private: true
          cors: false
  # Secrets API
  addSecret:
    handler: src/api/handler.addSecret
    events:
      - http:
          method: post
          path: v1/secrets
          private: true
          cors: false
  removeSecret:
    handler: src/api/handler.removeSecret
    events:
      - http:
          method: delete
          path: v1/secrets/{userId}/{secretId}
          private: true
          cors: false
  # Rules API
  getRules:
    handler: src/api/handler.getRules
    events:
      - http:
          method: get
          path: v1/rules
          private: true
          cors: false
  getRulesByUserId:
    handler: src/api/handler.getRulesByUserId
    events:
      - http:
          method: get
          path: v1/rules/{userId}
          private: true
          cors: false
  addRule:
    handler: src/api/handler.addRule
    events:
      - http:
          method: post
          path: v1/rules
          private: true
          cors: false
  removeRule:
    handler: src/api/handler.removeRule
    events:
      - http:
          method: delete
          path: v1/rules/{userId}/{ruleId}
          private: true
          cors: false

  # Scheduler
  scheduleArbitrage:
    handler: src/scheduler/handler.scheduleArbitrage
    events:
      - schedule: rate(1 minute)

# Dynamodb settings
resources:
  Resources:
    policiesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_POLICIES}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
    secretsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_SECRETS}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: secretId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: secretId
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
    rulesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_RULES}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: ruleId
            AttributeType: S
          - AttributeName: status
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: ruleId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: statusIndex
            KeySchema:
              - AttributeName: status
                KeyType: HASH
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
    transactionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_TRANSACTIONS}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: transactionId
            AttributeType: S
          - AttributeName: state
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: transactionId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: userIdIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: state
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

custom:
  # Alternative service properties
  service: *service
  # Local dynamodb settings
  dynamodb:
    start:
      port: 8000
      inMemory: true
      migrate: true
      seed: true
    seed:
      dev:
        sources:
          - table: ${self:provider.environment.DYNAMODB_TABLE_POLICIES}
            sources: [.seed/dev/fake-policies.json]
          - table: ${self:provider.environment.DYNAMODB_TABLE_SECRETS}
            sources: [.seed/dev/fake-secrets.json]
          - table: ${self:provider.environment.DYNAMODB_TABLE_RULES}
            sources: [.seed/dev/fake-rules.json]
          - table: ${self:provider.environment.DYNAMODB_TABLE_TRANSACTIONS}
            sources: [.seed/dev/fake-transactions.json]
      me:
        sources:
          - table: ${self:provider.environment.DYNAMODB_TABLE_POLICIES}
            sources: [.seed/me/my-policies.json]
          - table: ${self:provider.environment.DYNAMODB_TABLE_SECRETS}
            sources: [.seed/me/my-secrets.json]
          - table: ${self:provider.environment.DYNAMODB_TABLE_RULES}
            sources: [.seed/me/my-rules.json]
          - table: ${self:provider.environment.DYNAMODB_TABLE_TRANSACTIONS}
            sources: [.seed/me/my-transactions.json]
